<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Electricity Bill Explained</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:100,100i,200,200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,400i,700,700i">
</head>

<body >
    <h1 class="text-center text-white d-none d-lg-block site-heading"><span class="text-primary site-heading-upper mb-3">Electricity bill of Nepal Explained</span></h1>
    <section class="page-section cta" style="padding-top: 30px; padding-bottom: 30px;">
        <div class="container">
            <div class="row">
                <div class="col-xl-12 mx-auto">
                    <div class="cta-inner text-center rounded">
                        <h2 class="section-heading mb-5"><span class="section-heading-upper">Choose your configuration for domestic consumer(single phase)</span></h2>
                        <div class="form-group">
                            <div class="row">
                                <div class="col">
                                    <label for="ampere">Your meter ampere</label>
                                    <select name="ampere" id="ampere" class="form-control">
                                        <option value="5">5 Ampere</option>
                                        <option value="15" selected>15 Ampere</option>
                                        <option value="30">30 Ampere</option>
                                        <option value="60">60 Ampere</option>
                                    </select>
                                </div>
                                <div class="col">
                                    <label for="discount">Consumed units</label>
                                    <input type="number" id="units" placeholder="units" class="form-control">
                                </div>
                                <div class="col input-group">
                                    <label for="discount">Rebate discount percentage</label>
                                    <input type="number" name="discount" id="discount" placeholder="rebate discount" class="form-control">
                                    <div class="input-group-append">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="col">
                                    <div "form-check">
                                        <input type="checkbox" class="form-check-input" id="lockdowndiscount" value="25" checked>
                                        <label class="form-check-label" for="lockdowndiscount">Lockdown 25% off</label>
                                    </div>
                                    <button id="reset" class="btn btn-sm btn-secondary" type="button" style="margin-top: 15px;">Reset Fields</button>
                                </div>
                            </div>
                        </div>
                        <div class="list-unstyled mx-auto list-hours mt-5 mb-5 text-left" style="width: 100% !important;">
                            <div id="bill-heading" style="display: none;">
                                <div class="row hide d-flex list-unstyled-item list-hours-item">
                                    <div class="col">Service Charge Tariff</div>
                                    <div class="col">Unit Range</div>
                                    <div class="col">Units</div>
                                    <div class="col">Rate</div>
                                    <div class="col">Meter Charge</div>
                                </div>
                            </div>
                            <div id="bill-listing"></div>
                            <div id="total-listing" class="row d-flex list-unstyled-item list-hours-item"></div>
                        </div>
                        <div id="grand-total"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <footer class="footer text-faded text-center py-5">
        <div class="container">
            <p class="m-0 small">Copyright&nbsp;Â©&nbsp;Sachit Karki 2020</p>
        </div>
    </footer>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/current-day.js"></script>
    <script>
        $( document ).ready(function() {
            var lockdownDiscountPercent = 25;
            var tariff = {
                5: [
                    { min: 0, max: 20, rangeText: '0 - 20', serviceCharge: 30.00, energyCharge: 3.00 },
                    { min: 20, max: 30, rangeText: '21 - 30', serviceCharge: 50.00, energyCharge: 7.00 },
                    { min: 30, max: 50, rangeText: '31 - 50', serviceCharge: 75.00, energyCharge: 8.50 },
                    { min: 50, max: 150, rangeText: '51 - 150', serviceCharge: 100.00, energyCharge: 10.00 },
                    { min: 150, max: 250, rangeText: '151 - 250', serviceCharge: 125.00, energyCharge: 11.00 },
                    { min: 250, max: 400, rangeText: '251 - 400', serviceCharge: 150.00, energyCharge: 12.00 },
                    { min: 400, max: null, rangeText: 'Above 400', serviceCharge: 175.00, energyCharge: 13.00 }
                ],
                15: [
                    { min: 0, max: 20, rangeText: '0 - 20', serviceCharge: 50.00, energyCharge: 4.00 },
                    { min: 20, max: 30, rangeText: '21 - 30', serviceCharge: 75.00, energyCharge: 7.00 },
                    { min: 30, max: 50, rangeText: '31 - 50', serviceCharge: 100.00, energyCharge: 8.50 },
                    { min: 50, max: 150, rangeText: '51 - 150', serviceCharge: 125.00, energyCharge: 10.00 },
                    { min: 150, max: 250, rangeText: '151 - 250', serviceCharge: 150.00, energyCharge: 11.00 },
                    { min: 250, max: 400, rangeText: '251 - 400', serviceCharge: 175.00, energyCharge: 12.00 },
                    { min: 400, max: null, rangeText: 'Above 400', serviceCharge: 200.00, energyCharge: 13.00 }
                ],
                30: [
                    { min: 0, max: 20, rangeText: '0 - 20', serviceCharge: 75.00, energyCharge: 5.00 },
                    { min: 20, max: 30, rangeText: '21 - 30', serviceCharge: 100.00, energyCharge: 7.00 },
                    { min: 30, max: 50, rangeText: '31 - 50', serviceCharge: 125.00, energyCharge: 8.50 },
                    { min: 50, max: 150, rangeText: '51 - 150', serviceCharge: 150.00, energyCharge: 10.00 },
                    { min: 150, max: 250, rangeText: '151 - 250', serviceCharge: 175.00, energyCharge: 11.00 },
                    { min: 250, max: 400, rangeText: '251 - 400', serviceCharge: 200.00, energyCharge: 12.00 },
                    { min: 400, max: null, rangeText: 'Above 400', serviceCharge: 225.00, energyCharge: 13.00 }
                ],
                60: [
                    { min: 0, max: 20, rangeText: '0 - 20', serviceCharge: 125.00, energyCharge: 6.00 },
                    { min: 20, max: 30, rangeText: '21 - 30', serviceCharge: 150.00, energyCharge: 7.00 },
                    { min: 30, max: 50, rangeText: '31 - 50', serviceCharge: 175.00, energyCharge: 8.50 },
                    { min: 50, max: 150, rangeText: '51 - 150', serviceCharge: 200.00, energyCharge: 10.00 },
                    { min: 150, max: 250, rangeText: '151 - 250', serviceCharge: 225.00, energyCharge: 11.00 },
                    { min: 250, max: 400, rangeText: '251 - 400', serviceCharge: 250.00, energyCharge: 12.00 },
                    { min: 400, max: null, rangeText: 'Above 400', serviceCharge: 275.00, energyCharge: 13.00 }
                ]
            }

            $( "#ampere, #discount, #units, #lockdowndiscount" ).change(function() {
                clearCalculation();
                var ampere = $("#ampere").val();
                var totalUnits = parseInt($("#units").val());
                var discount = parseInt($("#discount").val());

                console.log(totalUnits, typeof totalUnits, );
                if( ampere == '' || Object.is(totalUnits, NaN) || totalUnits <= 0 || !tariff.hasOwnProperty(ampere))
                    return

                var totalCharge = 0;
                var unitRangeCharge = 0;
                var finalServiceCharge = 0;
                var selectedPlan = tariff[ampere];
                selectedPlan.forEach(function myFunction(value) {
                    var { min, max, energyCharge, serviceCharge, rangeText } = value;
                    var maxValue = ( max === null) ? totalUnits : max;
                    var consumedUnits = totalUnits;
                    if((totalUnits >= maxValue && max !== null) || (totalUnits > min && totalUnits <= maxValue)) {
                        var units = maxValue - min;
                        // when reached to category
                        if(totalUnits <= maxValue) {
                            units = consumedUnits - min;
                        }

                        consumedUnits -= units;
                        unitRangeCharge = units * parseFloat(value.energyCharge, 10);
                        totalCharge += unitRangeCharge;
                        finalServiceCharge = serviceCharge;
                        $("#bill-listing").append(addListItem(serviceCharge, rangeText, units, energyCharge, unitRangeCharge))
                    }
                });
                displayTotal(finalServiceCharge, totalUnits, discount, totalCharge);
            });

            // reset the fields
            $( "#reset" ).click(clearForm);

            function addListItem(serviceCharge, rangeText, units, energyCharge, unitRangeCharge) {
                return `<div class="row d-flex list-unstyled-item list-hours-item">
                    <div class="col">Rs. ${serviceCharge}</div>
                    <div class="col">${rangeText}</div>
                    <div class="col">${units}</div>
                    <div class="col">${energyCharge}</div>
                    <div class="col">Rs. ${unitRangeCharge}</div>
                </div>`;
            }

            function addTotalListing(finalServiceCharge, totalUnits, totalCharge) {
                return `<div class="col">Final Service Charge: Rs. ${finalServiceCharge}</div>
                        <div class="col">Total</div>
                        <div class="col">${totalUnits}</div>
                        <div class="col"></div>
                        <div class="col">Rs. ${totalCharge}</div>`;
            }

            function displayTotal(finalServiceCharge, totalUnits, discount, totalCharge){
                $("#bill-heading").show();
                $("#total-listing").html(addTotalListing(finalServiceCharge, totalUnits, totalCharge));
                $("#grand-total").html(addGrandTotal(totalCharge, discount, finalServiceCharge));
            }

            function addGrandTotal(totalUnitCharge, discount, finalServiceCharge) {
                var htmlContent = `<p><strong>Meter Charge: </strong>Rs. ${totalUnitCharge}</p>`;

                // lockdown discount
                if($("#lockdowndiscount").prop("checked") == true && lockdownDiscountPercent > 0){
                    console.log("Lockdown discount is given.");
                    var lockdownDiscountAmount = (totalUnitCharge * (lockdownDiscountPercent/100)).toFixed(2);
                    var totalUnitCharge = totalUnitCharge - lockdownDiscountAmount;
                    htmlContent = `${htmlContent}
                        <p><strong>Lockdown discount(${lockdownDiscountPercent}%): </strong>Rs. ${lockdownDiscountAmount}</p>
                        <p><strong>Total Meter Charge: </strong>Rs. ${totalUnitCharge}</p><br/>`;
                }

                // rebate discount
                if(discount > 0){
                    console.log("Rebate discount is given.");
                    var discountAmount = (totalUnitCharge * (discount/100)).toFixed(2);
                    var totalUnitCharge = totalUnitCharge - discountAmount;
                    htmlContent = `${htmlContent}
                        <p><strong>Rebate discount(${discount}%): </strong>Rs. ${discountAmount}</p>
                        <p><strong>Total Meter Charge: </strong>Rs. ${totalUnitCharge}</p><br/>`;
                }

                return `${htmlContent}
                        <p><strong>Service Charge: </strong>Rs. ${finalServiceCharge}</p>
                        <p><strong>Total Charge: </strong>Rs. ${totalUnitCharge + finalServiceCharge}</p>`;
            }

            function clearForm() {
                $("#ampere").val(15);
                $("#discount").val(25);
                $("#rebate").val('');
                $("#units").val('');
                clearCalculation();
            }

            function clearCalculation() {
                $("#bill-heading").hide();
                $("#bill-listing").html('');
                $("#total-listing").html('');
                $("#grand-total").html('');
            }
        });


    </script>
</body>

</html>